===================================================================================
DAFTAR LENGKAP PERBAIKAN WEBSOCKET - DERIV TRADING BOT
===================================================================================

MASALAH UTAMA:
1. WebSocket sering disconnect/timeout
2. Trading status tidak update real-time
3. Auto-trading toggle tidak reflect status sebenarnya
4. Balance dan trade statistics tidak update
5. Deriv API proposal request timeout
6. Auto-trading tidak execute trades meskipun enabled

===================================================================================
PERBAIKAN 1: DERIV WEBSOCKET CONNECTION (deriv_ws.py)
===================================================================================

A. Connection Readiness & Timeout Handling
   - Tambah threading.Event untuk connection readiness barrier
   - Implementasi proper timeout handling di connect() method
   - Fix race condition saat WebSocket opening
   - Timeout default 15 detik untuk connection establishment

B. Reconnection Logic dengan Exponential Backoff
   - Max reconnect attempts: 5 kali
   - Delay exponential: 5s, 7.5s, 11.25s, dst (max 60s)
   - Auto-reconnect saat connection lost
   - Proper cleanup saat reconnection

C. Request-Response Tracking
   - Request ID tracking dengan threading.Event
   - Response timeout handling (default 30 detik)
   - Prevent request hanging dengan automatic cleanup
   - Proper error handling untuk timeout requests

D. Ping/Pong Heartbeat Mechanism
   - Interval ping: 30 detik via WebSocketApp
   - Ping timeout: 10 detik
   - Health check thread terpisah untuk monitoring
   - Auto-disconnect jika ping/pong failed

E. Error Handling & Recovery
   - Detailed error messages untuk authorization failures
   - Translate error codes ke bahasa user-friendly
   - State reset saat connection failed
   - Connection error tracking dengan _connection_error

F. Authorization Flow
   - Proper authorization dengan timeout
   - Return tuple (success, error_message) untuk feedback
   - Last auth error tracking untuk debugging
   - Auto-reset state setelah auth failure

===================================================================================
PERBAIKAN 2: WEB SERVER WEBSOCKET (web_server.py)
===================================================================================

A. ConnectionManager Enhancement
   - Heartbeat mechanism untuk client connections
   - Connection timeout detection (90 detik no pong)
   - Telegram ID to User ID mapping
   - Connection info tracking (telegram_id, connected_at, last_ping/pong)

B. Session Management
   - Proper session linking antara Telegram dan WebSocket
   - User strategy tracking
   - Deriv token dan account sync
   - Session cleanup saat logout

C. Broadcasting System
   - Event-based broadcasting (trade_opened, trade_closed, status_update)
   - User-specific broadcasts berdasarkan telegram_id
   - Broadcast to all connections untuk general updates
   - Rate limiting untuk prevent spam

D. Reconnection Handling
   - Exponential backoff: 1.5^attempts (max 30 detik)
   - Max attempts: 10 kali
   - Auto-retry saat connection lost
   - Connection state tracking

E. Ping/Pong Protocol
   - Server ping interval: 30 detik
   - Client pong tracking
   - Disconnect stale connections
   - Connection quality monitoring

===================================================================================
PERBAIKAN 3: FRONTEND WEBSOCKET (HTML Files)
===================================================================================

A. WebSocket Reconnection (All webapps)
   - Exponential backoff reconnection
   - Max 10 reconnect attempts
   - Visual status indicators (Connected/Disconnected/Connecting)
   - Prevent multiple connection instances

B. Connection Status UI
   - Status badge dengan 3 states: running, stopped, connecting
   - WebSocket dot indicator (green/red)
   - Status text updates real-time
   - Pulse animation untuk connecting state

C. Message Handling
   - Proper JSON parsing dengan error handling
   - Event type routing (trade_opened, trade_closed, status_update)
   - Ping/pong response handling
   - Error message display

D. Auto-Trading Integration
   - Toggle sync dengan backend status
   - Status polling setiap 5 detik sebagai fallback
   - Prevent race conditions saat toggle
   - Proper state management

E. Statistics Update
   - Real-time balance updates
   - Win rate calculation
   - Profit/loss tracking
   - Trade count updates

===================================================================================
PERBAIKAN 4: TRADING MANAGER (trading.py)
===================================================================================

A. WebSocket Integration
   - Set on_contract_update callback
   - Subscribe/unsubscribe tick streams properly
   - Handle WebSocket disconnection gracefully
   - Wait for pending trades sebelum stop

B. Trade Execution Flow
   - Check WebSocket connection sebelum trade
   - Proper timeout handling untuk proposals (15s)
   - Contract tracking dengan contract_id
   - Auto-subscribe contract updates

C. Status Broadcasting
   - Broadcast trade_opened dengan contract details
   - Broadcast trade_closed dengan profit/stats
   - Broadcast status_update untuk UI sync
   - Progress notifications setiap 10 trades

D. Error Recovery
   - Session recovery dari file
   - Auto-save state setiap trade
   - Martingale level tracking
   - Balance verification

===================================================================================
PERBAIKAN 5: API ENDPOINTS (web_server.py)
===================================================================================

A. Trading Control Endpoints
   - POST /api/trading/start - Start auto trading
   - POST /api/trading/stop - Stop auto trading
   - GET /api/trading/status - Get current status
   - Proper telegram_id validation

B. Status Sync
   - Real-time status via WebSocket
   - Fallback polling via HTTP
   - Balance sync dari Deriv
   - Trade statistics sync

C. Error Handling
   - HTTP 400/401/500 status codes
   - Detailed error messages
   - Validation errors
   - Connection errors

===================================================================================
PERBAIKAN 6: STATE MANAGEMENT
===================================================================================

A. Session State
   - session_manager untuk user sessions
   - Deriv token storage
   - Account info caching
   - Strategy selection tracking

B. Trading State
   - TradingState enum (IDLE, RUNNING, PAUSED, STOPPING)
   - Active trade tracking
   - Pending result flag
   - Session statistics

C. Connection State
   - Connected/Authorized flags
   - Last ping/pong timestamps
   - Connection error tracking
   - Reconnection attempts

===================================================================================
PERBAIKAN 7: VISUAL FEEDBACK
===================================================================================

A. Status Indicators
   - Badge colors: green (running), red (stopped), yellow (connecting)
   - WebSocket dot: green (connected), red (disconnected)
   - Pulse animation untuk connecting state
   - Status text updates

B. Error Messages
   - User-friendly error messages
   - Detailed logging untuk debugging
   - Toast notifications (jika ada)
   - Console warnings

C. Loading States
   - Disabled buttons saat processing
   - Loading spinners (optional)
   - Progress indicators
   - Transition animations

===================================================================================
PERBAIKAN 8: LOGGING & DEBUGGING
===================================================================================

A. Comprehensive Logging
   - Connection events
   - Trade execution steps
   - Error details
   - State changes

B. Debug Information
   - Request/response logging
   - Timeout tracking
   - Connection quality metrics
   - Performance monitoring

===================================================================================
TESTING CHECKLIST
===================================================================================

✓ WebSocket connection establishment (< 15s)
✓ Auto-reconnect setelah disconnect
✓ Heartbeat ping/pong working
✓ Trade execution tanpa timeout
✓ Real-time balance updates
✓ Status sync antara frontend-backend
✓ Multiple user connections
✓ Connection cleanup saat logout
✓ Error handling untuk bad tokens
✓ Session recovery setelah crash

===================================================================================
CONFIGURATION VARIABLES
===================================================================================

Deriv WebSocket:
- Connection timeout: 15 detik
- Request timeout: 30 detik
- Ping interval: 30 detik
- Ping timeout: 10 detik
- Max reconnect: 5 kali
- Reconnect delay: 5s exponential

Web Server WebSocket:
- Connection timeout: 90 detik
- Ping interval: 30 detik
- Max reconnect: 10 kali
- Reconnect delay: 1.5^n exponential (max 30s)

Trading:
- Signal cooldown: 12 detik
- Min confidence: 55%
- Min confluence: 40
- Proposal timeout: 15 detik

===================================================================================
FILE CHANGES SUMMARY
===================================================================================

Modified Files:
1. deriv_ws.py - Core WebSocket connection dengan proper timeout & reconnection
2. web_server.py - WebSocket server dengan heartbeat & session management
3. trading.py - Integration dengan WebSocket untuk real-time updates
4. webapps/terminal.html - Frontend WebSocket dengan reconnection
5. webapps/tick-picker.html - Frontend WebSocket dengan reconnection
6. webapps/digitpad.html - Frontend WebSocket dengan reconnection
7. webapps/amt.html - Frontend WebSocket dengan reconnection
8. webapps/sniper.html - Frontend WebSocket dengan reconnection

===================================================================================
IMPLEMENTATION ORDER
===================================================================================

Phase 1: Core WebSocket (deriv_ws.py)
- Connection readiness
- Timeout handling
- Reconnection logic
- Heartbeat mechanism

Phase 2: Server WebSocket (web_server.py)
- ConnectionManager enhancement
- Broadcasting system
- Session management
- API endpoints

Phase 3: Frontend Integration (HTML files)
- WebSocket client dengan reconnection
- Status indicators
- Event handling
- Auto-trading sync

Phase 4: Trading Integration (trading.py)
- Callback integration
- Status broadcasting
- Error recovery
- Session management

Phase 5: Testing & Optimization
- Connection stability testing
- Load testing
- Error scenario testing
- Performance optimization

===================================================================================